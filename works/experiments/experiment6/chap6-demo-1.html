<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>实验六 - Phong & Gouraud 球体 + bones.obj</title>
    <style>
        body { font-family: sans-serif; display: flex; gap: 12px; margin: 12px; }
        canvas { border: 1px solid #222; background: #111; }
        #controls { padding: 10px; width: 360px; display: flex; flex-direction: column; gap: 10px; }
        .control-group { border: 1px solid #ccc; padding: 10px; border-radius: 6px; background: #fafafa; }
        .control-group h3 { margin: 0 0 6px 0; font-size: 14px; }
        label { display: block; margin-top: 6px; font-size: 13px; }
        .row { display:flex; gap:8px; align-items:center; }
        .small { width: 70px; }
    </style>
</head>
<body>
    <canvas id="webgl-canvas" width="700" height="700">请使用支持WebGL的浏览器</canvas>

    <div id="controls">
        <div class="control-group">
            <h3>渲染 / 模型</h3>
            <label>模型:
                <select id="model-select">
                    <option value="sphere">Sphere</option>
                    <option value="bones">Bones (OBJ)</option>
                </select>
            </label>
            <label>Shading:
                <select id="shading-mode">
                    <option value="phong">Phong (per-fragment)</option>
                    <option value="gouraud">Gouraud (per-vertex)</option>
                </select>
            </label>
            <label>绘制模式:
                <select id="draw-mode">
                    <option value="solid">面片 (Solid)</option>
                    <option value="wireframe">线框 (Wireframe)</option>
                </select>
            </label>
            <label>细分级别 (Subdivision): <input type="range" id="subdivision" min="0" max="5" value="4"></label>
            <div class="row">
                <label class="small">材质颜色:</label>
                <input type="color" id="mat-color" value="#888888">
                <label class="small">高光色:</label>
                <input type="color" id="spec-color" value="#ffffff">
            </div>
            <label>高光亮度 (shininess): <input type="range" id="shininess" min="1" max="256" value="64"></label>
            <label>环境系数 ka: <input type="range" id="ka" min="0" max="1" step="0.01" value="0.2"></label>
            <label>漫反射系数 kd: <input type="range" id="kd" min="0" max="1" step="0.01" value="1.0"></label>
            <label>镜面反射系数 ks: <input type="range" id="ks" min="0" max="1" step="0.01" value="0.5"></label>
        </div>

        <div class="control-group">
            <h3>光源</h3>
            <div class="row">
                <label class="small">光源颜色:</label>
                <input type="color" id="light-color" value="#ffffff">
            </div>
            <label>光源位置 X: <input type="range" id="light-x" min="-10" max="10" value="2" step="0.1"></label>
            <label>光源位置 Y: <input type="range" id="light-y" min="-10" max="10" value="2" step="0.1"></label>
            <label>光源位置 Z: <input type="range" id="light-z" min="-10" max="10" value="2" step="0.1"></label>
            <label>是否使用 Blinn-Phong: <input type="checkbox" id="use-blinn" checked></label>
        </div>

        <div class="control-group">
            <h3>投影 / 相机</h3>
            <label>投影方式:
                <select id="projection-mode">
                    <option value="perspective">透视 (Perspective)</option>
                    <option value="ortho">正交 (Orthographic)</option>
                </select>
            </label>
            <label>FovY (deg): <input type="range" id="persp-fovy" min="10" max="120" value="45"></label>
            <label>相机距离: <input type="range" id="cam-dist" min="1" max="50" value="5"></label>
            <div style="font-size:12px; margin-top:8px">鼠标拖拽旋转；滚轮缩放。</div>
        </div>
    </div>

    <!-- Phong (per-fragment) -->
    <script id="vs-phong" type="x-shader/x-vertex">
        attribute vec3 a_Position;
        attribute vec3 a_Normal;

        uniform mat4 u_ModelView;
        uniform mat4 u_Projection;
        uniform mat3 u_NormalMatrix;

        varying vec3 v_Normal;
        varying vec3 v_FragPos;

        void main() {
            vec4 viewPos = u_ModelView * vec4(a_Position, 1.0);
            v_FragPos = viewPos.xyz;
            v_Normal = normalize(u_NormalMatrix * a_Normal);
            gl_Position = u_Projection * viewPos;
        }
    </script>

    <script id="fs-phong" type="x-shader/x-fragment">
        precision mediump float;

        varying vec3 v_Normal;
        varying vec3 v_FragPos;

        uniform vec3 u_LightPos; // in view space
        uniform vec3 u_LightColor;
        uniform vec3 u_ViewPos; // in view space

        uniform vec3 u_Ka;
        uniform vec3 u_Kd;
        uniform vec3 u_Ks;
        uniform float u_Shininess;
        uniform bool u_UseBlinn;

        void main() {
            vec3 N = normalize(v_Normal);
            vec3 L = normalize(u_LightPos - v_FragPos);
            vec3 V = normalize(u_ViewPos - v_FragPos);

            // ambient
            vec3 ambient = u_Ka * u_LightColor;

            // diffuse
            float diff = max(dot(N, L), 0.0);
            vec3 diffuse = u_Kd * u_LightColor * diff;

            // specular (Blinn or Phong)
            float spec = 0.0;
            if (diff > 0.0) {
                if (u_UseBlinn) {
                    vec3 H = normalize(L + V);
                    spec = pow(max(dot(N, H), 0.0), u_Shininess);
                } else {
                    vec3 R = reflect(-L, N);
                    spec = pow(max(dot(R, V), 0.0), u_Shininess);
                }
            }
            vec3 specular = u_Ks * u_LightColor * spec;

            vec3 color = ambient + diffuse + specular;
            gl_FragColor = vec4(color, 1.0);
        }
    </script>

    <!-- Gouraud (per-vertex) -->
    <script id="vs-gouraud" type="x-shader/x-vertex">
        attribute vec3 a_Position;
        attribute vec3 a_Normal;

        uniform mat4 u_ModelView;
        uniform mat4 u_Projection;
        uniform mat3 u_NormalMatrix;

        uniform vec3 u_LightPos;
        uniform vec3 u_LightColor;
        uniform vec3 u_ViewPos;

        uniform vec3 u_Ka;
        uniform vec3 u_Kd;
        uniform vec3 u_Ks;
        uniform float u_Shininess;
        uniform bool u_UseBlinn;

        varying vec3 v_Color;

        void main() {
            vec4 viewPos = u_ModelView * vec4(a_Position, 1.0);
            vec3 fragPos = viewPos.xyz;
            vec3 N = normalize(u_NormalMatrix * a_Normal);
            vec3 L = normalize(u_LightPos - fragPos);
            vec3 V = normalize(u_ViewPos - fragPos);

            vec3 ambient = u_Ka * u_LightColor;
            float diff = max(dot(N, L), 0.0);
            vec3 diffuse = u_Kd * u_LightColor * diff;

            float spec = 0.0;
            if (diff > 0.0) {
                if (u_UseBlinn) {
                    vec3 H = normalize(L + V);
                    spec = pow(max(dot(N, H), 0.0), u_Shininess);
                } else {
                    vec3 R = reflect(-L, N);
                    spec = pow(max(dot(R, V), 0.0), u_Shininess);
                }
            }
            vec3 specular = u_Ks * u_LightColor * spec;

            v_Color = ambient + diffuse + specular;
            gl_Position = u_Projection * viewPos;
        }
    </script>

    <script id="fs-gouraud" type="x-shader/x-fragment">
        precision mediump float;
        varying vec3 v_Color;
        void main() {
            gl_FragColor = vec4(v_Color, 1.0);
        }
    </script>

    <script src="../../lib/webgl-utils.js"></script>
    <script src="../../lib/initShaders.js"></script>
    <script src="../../lib/gl-matrix-min.js"></script>
    <script src="chap6-demo-1.js"></script>
</body>
</html>
